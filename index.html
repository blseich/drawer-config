
<!DOCTYPE html>
<html ng-app="JSConfigApp">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/bootstrap.min.css" />

  <!-- inportant: this css should remain linked by brand -->
  <link rel="stylesheet" href="css/spotlight-drawer.css" />
  <link rel="stylesheet" designation="brandedCSS" type="text/css" href="brand-css-files/ON-style.css">
  <link rel="stylesheet" designation="brandedCSS" type="text/css" href="brand-css-files/AT-style.css">
  <link rel="stylesheet" designation="brandedCSS" type="text/css" href="brand-css-files/GAP-style.css">
  <link rel="stylesheet" designation="brandedCSS" type="text/css" href="brand-css-files/BR-style.css">

  <link rel="stylesheet" href="css/textAngular.css" />
  <link rel="stylesheet" href="css/font-awesome.min.css" />
  <link rel="stylesheet" href="css/spectrum.min.css" />
  <link rel="stylesheet" href="css/image-mapper-main.css" />
  <script src="js/jquery-2.2.1.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/angular.min.js"></script>
  <script src='js/ui-bootstrap-tpls-1.2.0.js'></script>
</head>
<style>
  .drawer-item {
    margin-bottom: 22px;
  }

  .hidden {
    display: none;
  }

  body.modal-open {
    overflow: inherit;
    padding-right: 0 !important;
  }

  .btn-file {
    position: relative;
    overflow: hidden;
  }

  .btn-file input[type=file] {
    position: absolute;
    top: 0;
    right: 0;
    min-width: 100%;
    min-height: 100%;
    font-size: 100px;
    text-align: right;
    filter: alpha(opacity=0);
    opacity: 0;
    outline: none;
    background: white;
    cursor: inherit;
    display: block;
  }

  .full-spectrum .sp-palette {
    max-width: 200px;
  }

  .btn-blue {
    border-color: #000;
    border: 1px solid rgba(0, 0, 0, 0.13);
  }

  .btn-toolbar>.btn-group {
    margin-bottom: 12px;
  }

  ul#brand-selector li {
    display: inline;
    padding: 0 8px
  }

  [ta-button] {
    height: 44px;
    margin-bottom: 5px;
  }
</style>

<body ng-controller="JSConfigAppCtrl">
  <div class="container">
    <div class="row">
      <div class="col-sm-12">
        <div class="jumbotron" ng-hide="promos.global.headerText || promos.global.subHeaderText">
          <h1 style="">Promo Drawer Builder</h1>
        </div>
      </div>
      <div class="col-sm-12">
        <div class="jumbotron" ng-show="promos.global.headerText || promos.global.subHeaderText">
          <h1 style="text-transform:uppercase">{{promos.global.headerText}}</h1>
          <p style="text-transform:uppercase">{{promos.global.subHeaderText}}</p>
        </div>
      </div>
      <div class="col-sm-12">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h2 class="panel-title">Brand selector</h2>
          </div>
          <div class="panel-body">
            <ul id="brand-selector">
              <li ng-repeat="brandChoice in brandChoices">
                <input type="radio" name="brand-selector" ng-click="brandUpdate(brandChoices[$index])" ng-model="assignedBrand" ng-value="brandChoices[$index]" /> {{brandChoice}}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <form name="cellForm" ng-submit="submitForm(cellForm.$valid)" novalidate>
      <div class="row">
        <div class="col-sm-12">
          <div class="form-group" ng-class="{ 'has-error' : cellForm.headerText.$invalid && !cellForm.headerText.$pristine }">
            <label for="headerText">Drawer Header Text</label>
            <input type="text" name="headerText" class="form-control" ng-model="promos.global.headerText" id="headerText" placeholder="Enter Header Text" required ng-minlength="1">
            <p ng-show="cellForm.headerText.$error.minlength" class="help-block">Minimum of 1 character.</p>
            <p ng-show="cellForm.headerText.$error.maxlength" class="help-block">24 characters maximum.</p>
          </div>
          <div class="form-group">
            <label for="headerSubText">Drawer Header Sub Text</label>
            <input type="text" class="form-control" ng-model="promos.global.subHeaderText" id="headerSubText" placeholder="Enter Header Sub Text">
          </div>
        </div>
      </div>
      <div class="row" ng-repeat="promo in promos.global.promos track by $index">
        <div class="col-sm-12">
          <div class="panel panel-info">
            <div class="panel-heading">
              <h2 class="panel-title">Drawer Cell {{$index + 1}}
							  <button
							    ng-show="promos.global.promos.length > 1"
							    style="margin-left:12px;line-height:18px;"
							    ng-click="moveCell($index,1)"
							    class="btn btn-info btn-xs fa fa-arrow-circle-down">
							  </button>
							  <button
							    ng-show="promos.global.promos.length > 1"
							    style="margin-left:12px;line-height:18px;"
							    ng-click="moveCell($index,-1)"
							    class="btn btn-info btn-xs fa fa-arrow-circle-up">
							  </button>
                <button
                  ng-show="promos.global.promos.length > 1"
                  class="btn pull-right btn-info btn-xs fa fa-times"
                  ng-click="delete($index)">
							  </button>
							</h2>
            </div>
            <div class="panel-body">
              <div class="col-sm-7">
                <div class="panel panel-default">
                  <div class="panel-heading">Banner Content</div>
                  <div class="panel-body">
                    <div class="col-sm-12">
                      <div class="form-group">
                        <div class="radio">
                          <label class="radio-inline">
                            <input
                              type="radio"
                              ng-model="promo.bannerContent.imgOrHTML"
                              value="img"
                              name="group_{{$index}}">
                            <strong>Image</strong> - Cell loads an image with options for linking.
                          </label>
                        </div>
                        <div class="radio">
                          <label class="radio-inline">
                            <input
                              type="radio"
                              ng-model="promo.bannerContent.imgOrHTML"
                              value="html"
                              name="group_{{$index}}">
                            <strong>HTML</strong> - edit banner contents
                          </label>
                        </div>
                      </div>
                      <div class="img-container" ng-show="promo.bannerContent.imgOrHTML == 'img'">
                        <div class="form-group">
                          <span
                            class="btn btn-success btn-file"
                            ng-hide="promo.bannerContent.img.images.dataUri">
														Import image (600w x 332h, 48kb max)
                            <input id="the-img-input" ng-click="setPageNumber($index)" type="file" >
													</span>
                          <span
                            class="btn btn-warning btn-file"
                            ng-show="promo.bannerContent.img.images.dataUri">
														Update image (600w x 332h, 48kb max)
                            <input id="the-img-input" ng-click="setPageNumber($index)" type="file" >
													</span>
                          <button
                            class="btn btn-danger"
                            ng-click="erasePic($index)"
                            ng-show="promo.bannerContent.img.images.dataUri">Delete image</button>
                        </div>
                        <div class="form-group" ng-show="promo.bannerContent.img.images.dataUri">
                          <img data-ng-src="{{promo.bannerContent.img.images.dataUri}}" class="img-responsive">
                          <div style="margin-top:15px;" class="alert alert-warning" ng-show="imgError">
                            <h4>Warning!</h4>
                            <p>{{imgError}}</p>
                          </div>
                        </div>
                        <!--
                        <div class="form-group" ng-hide="promo.bannerContent.img.images.dataUri">
                          <label for="inputImageUrl">Cell image path</label>
                          <input
                            type="text"
                            ng-model="promo.bannerContent.img.images.path"
                            class="form-control"
                            id="inputImageUrl"
                            placeholder="URL">
                        </div>
                        -->
                        <div class="form-group" ng-show="promo.bannerContent.img.images.dataUri">
                          <div class="checkbox">
                            <label>
                              <input type="checkbox" ng-model="promo.bannerContent.img.contentParameters.linkType">Link image</input>
                            </label>
                          </div>
                          <button
                            ng-show="promo.bannerContent.img.contentParameters.linkType"
                            type="button"
                            class="btn btn-info mapButton"
                            ng-click="mapImgModal($index, promo.bannerContent.img.images.dataUri, promo.bannerContent.img.contentParameters.imageMap)"
                            >Edit Image Map</button>
                            <br ng-show="promo.bannerContent.img.contentParameters.linkType"/><br ng-show="promo.bannerContent.img.contentParameters.linkType"/>
                            <textarea
                              ng-show="promo.bannerContent.img.contentParameters.imageMap && promo.bannerContent.img.contentParameters.linkType"
                              class="form-control mapCode"
                              rows="5" id="textArea"
                              ng-model="promo.bannerContent.img.contentParameters.imageMap"
                              ></textarea>
                        </div>
                      </div>

                      <div class="HTML-container" ng-show="promo.bannerContent.imgOrHTML == 'html'">
                        <ul class="nav nav-tabs">
                          <li class="active"><a href="#editor{{$index}}" data-toggle="tab" aria-expanded="true">Editor</a></li>
                          <li class=""><a href="#css{{$index}}" data-toggle="tab" aria-expanded="false">CSS</a></li>
                        </ul>
                        <div id="myTabContent" class="tab-content">
                          <div class="tab-pane fade active in" id="editor{{$index}}" style="margin-top:24px;">
                            <div class="form-group" ng-show="promo.bannerContent.HTML.useLocal">
                              <text-angular ng-model="promo.bannerContent.HTML.localHTML" class="html-banner-branded ON-style"></text-angular>
                            </div>
                            <div class="form-group" ng-show="promo.bannerContent.HTML.useLocal">
                              <label for="bgcolor">Background Color</label>
                              <br>
                              <spectrum-colorpicker name="bgcolor" ng-model="promo.bannerContent.HTML.backgroundColor" format="'hex'" class="bg-colorpicker" on-change="bgColorChange($index)" options="{replacerClassName: 'fa fa-eyedropper', showButtons: true, showInput: true, preferredFormat: 'hex'}"></spectrum-colorpicker>
                            </div>
                          </div>
                          <div class="tab-pane fade" id="css{{$index}}" style="margin-top:24px;">
                            <div class="form-group">
                              <label for="textArea" class="col-lg-1 control-label">CSS</label>
                              <div class="col-lg-11">
                                <textarea class="form-control" rows="24" id="textArea" ng-model="promo.bannerContent.HTML.css"></textarea>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-5">
                <div class="panel panel-default">
                  <div class="panel-heading">Banner Footer</div>
                  <div class="panel-body">
                    <div class="panel panel-default">
                      <div class="panel-body">
                        <div class="col-sm-12">
                          <h2>Promotion Type</h2>
                          <div class="form-group">
                            <div class="radio">
                              <label class="radio-inline">
                                <input type="radio" ng-model="promo.tapContent.displayType" value="generic" name="tapType_{{$index}}" ng-click="promo.tapContent.redeemMessage = 'Use code <generic> at checkout'">
                                <strong>Generic</strong> - display generic code and popup link containing terms & condtions
                              </label>
                            </div>
                            <div class="radio">
                              <label class="radio-inline">
                                <input type="radio" ng-model="promo.tapContent.displayType" value="auto" name="tapType_{{$index}}" ng-click="promo.tapContent.redeemMessage = 'discount automatically applied at checkout'">
                                <strong>Auto apply</strong> - display redeem message and popup link containing terms & condtions
                              </label>
                            </div>
                            <div class="radio">
                              <label class="radio-inline">
                                <input type="radio" ng-model="promo.tapContent.displayType" value="tap" name="tapType_{{$index}}" ng-change="attachRedeem()">
                                <strong>Tap to apply</strong> - display a button to apply code and popup link containing terms & condtions
                              </label>
                            </div>
                            <div class="radio">
                              <label class="radio-inline">
                                <input type="radio" ng-model="promo.tapContent.displayType" value="none" name="tapType_{{$index}}" ng-click="promo.tapContent.redeemMessage = 'No code required'">
                                <strong>None</strong> - custom Redeem Message and popup link with manually entered terms & conditions. For events with no PPC ID
                              </label>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="panel panel-default" ng-hide="promo.tapContent.displayType == 'none'">
                      <div class="panel-body">
                        <form class="form">
                          <div class="col-sm-6">
                            <div class="form-group" ng-hide="promo.tapContent.displayType == 'none'" ng-class="{ 'has-error' : cellForm.genericCodeId.$invalid && !cellForm.genericCodeId.$pristine }">
                              <label for="genericCodeId">PPC ID</label>
                              <input type="text" name="genericCodeId" ng-model="promo.tapContent.genericCodeId" class="form-control" id="genericCodeId" ng-pattern="/^[0-9]*$/" placeholder="123456">
                              <p ng-show="cellForm.genericCodeId.$error.pattern" class="help-block">Only numbers are allowed.</p>
                            </div>
                          </div>
                          <div class="col-sm-6">
                            <div class="form-group" ng-hide="promo.tapContent.displayType == 'none' || promo.tapContent.displayType == 'auto'">
                              <label for="genericCode">Generic code</label>
                              <input name="genericCode" type="text" ng-model="promo.tapContent.genericCode" class="form-control" id="genericCode" placeholder="SAVENOW">
                            </div>
                          </div>
                          <div class="col-sm-12">
                            <button
                              ng-show="promo.tapContent.genericCodeId"
                              class="btn btn-info btn-block"
                              ng-click="ppcCheckModal(promo.tapContent.genericCodeId,$index,'bananarepublic')">Validate PPC ID</button>

                          </div>
                        </form>
                      </div>
                    </div>
                    <div class="panel panel-default">
                      <div class="panel-body">
                        <div class="col-sm-7" ng-hide="promo.tapContent.displayType == 'tap'">
                          <div class="form-group">
                            <label for="inputUrl">Redeem message</label>
                            <textarea class="form-control" rows="2" id="textArea" ng-model="promo.tapContent.redeemMessage"></textarea>
                          </div>
                        </div>
                        <div class="col-sm-5">
                          <div class="form-group">
                            <label for="popupTextLink">Popup Link</label>
                            <input type="text" name="popupTextLink" ng-model="promo.tapContent.popupTextLink" class="form-control">
                          </div>
                        </div>

                        <div class="col-sm-12">
                          <div class="form-group" ng-hide="promo.tapContent.displayType == 'none'">
                            <label>
                              <input type="checkbox" ng-model="promo.tapContent.useLegalOverride"> Override popup text? If unchecked, terms & conditions will be automatically pulled from PPC through ecom.
                            </label>
                          </div>

                          <div class="form-group" ng-show="promo.tapContent.useLegalOverride">
                            <label for="inputUrl">Terms & condutions popup text override</label>
                            <textarea class="form-control" rows="12" id="textArea" ng-model="promo.tapContent.legalOverride" placeholder="Little promotion
that makes the business sing,
what are your details?"></textarea>
                          </div>
                          <div class="form-group" ng-show="promo.tapContent.displayType == 'none' && promo.tapContent.popupTextLink">
                            <label for="inputUrl">Terms & condutions popup text</label>
                            <textarea class="form-control" rows="12" id="textArea2" ng-model="promo.tapContent.legalOverride" placeholder="Little promotion
that makes the business sing,
what are your details?"></textarea>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!--
                    <div class="form-group" ng-show="promo.tapContent.genericCode && promo.tapContent.genericCodeId && promo.tapContent.displayType != 'none'">
                      <label for="preview">iframe preview</label>
                      <iframe name="preview" frameborder="0" scrolling="yes" ng-src="{{cleanUrl($index)}}"></iframe>
                    </div>
                    -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-sm-12">
          <button style="margin-bottom: 22px;" class="btn btn-success pull-right" ng-click="addItem()">Add promo cell</button>
          <br>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-3">
        </div>
        <div class="col-sm-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h2 class="panel-title">Preview : Iphone 4 resolution</h2>
            </div>
            <div class="panel-body" style="width:350px;margin:15px auto;padding:0;background:#e0e1e1;">
              <div id="promoDrawer__handlebar">
                <div id="promoDrawer__handlebar__text">
                  <div class="promoDrawer__title closed" style="display: block;">{{promos.global.headerText}}</div>
                  <div class="promoDrawer__subtitle closed" style="display: block;">{{promos.global.subHeaderText}}</div>
                </div>
              </div>
              <div class="offerspotlight-drawer" style="position:relative!important;">
                <div class="offerspotlight-drawer-slider">
                  <div class="offerspotlight-drawer-slider-items">
                    <div class="offerspotlight-drawer-slider-item" ng-repeat="promo in promos.global.promos track by $index" ng-show="promo.bannerContent.img.images.path || promo.bannerContent.img.images.dataUri || promo.bannerContent.HTML.path || promo.bannerContent.HTML.useLocal">
                      <div class="item-banner-content" ng-show="promo.bannerContent.imgOrHTML == 'html' && promo.bannerContent.HTML.useLocal">
                        <div style="vertical-align:middle;width:256px;height:142px;">
                          <div ng-bind-html="promo.bannerContent.HTML.localHTML" class="html-banner-branded ON-style html-preview" style="height:100%">
                          </div>
                        </div>
                      </div>
                      <div class="item-banner-content" ng-show="promo.bannerContent.imgOrHTML == 'html' && !promo.bannerContent.HTML.useLocal">
                        <iframe frameborder="0" scrolling="no" style="width:256px;height:142px;" ng-src="{{promo.bannerContent.HTML.path}}"></iframe>
                      </div>
                      <div class="item-banner-content" ng-show="promo.bannerContent.imgOrHTML == 'img'">
                          <img width="256" height="142" class="bannerimg" data-ng-src="{{promo.bannerContent.img.images.dataUri}}">
                      </div>
                      <div class="spotlight-footer">
                        <div class="control-code column1">
                          <a href="#" class="redeem" ng-show="promo.tapContent.displayType == 'tap'">TAP TO APPLY</a>
                          <span class="gen" ng-hide="promo.tapContent.displayType == 'tap'">{{promo.tapContent.redeemMessage}}</span>
                        </div>
                        <div class="control-apply column2">
                          <a href="#normal" class="legal-details">
                            <span class="legal">{{promo.tapContent.popupTextLink}}</span>
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-3">
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <div class="panel panel-default">
            <div class="panel-body">
              <div class="col-sm-6">
                <span class="btn btn-default btn-block btn-file">
									Import config.json file <input id="the-file-input" type="file">
								</span>
              </div>
              <div class="col-sm-6">
                <a download="config.json" class="btn btn-primary btn-block" role="button" ng-href="data:text/json;charset=utf-8,{{myEncodeJson(promos)}}">Export config.json file</a>
              </div>
            </div>
          </div>
        </div>
      </div>

<!--
			<div class="row">
				<div class="col-sm-12">
					<div class="panel panel-default">
					<div class="panel-heading">Output</div>
					<div class="panel-body"><code>{{promos}}</code></div>
				</div>
				</div>
			</div>
-->
      <div class="row">
        <div class="col-sm-12"></div>
      </div>
  </div>
  </form>

  <script type="text/ng-template" id="ppcCodeCheck.html">
    <div class="modal-header">
      <button type="button" class="close" ng-click="dismiss()">&times;</button>
      <h4 class="modal-title">PPC code check for {{ppcId}} at {{brand}}</h4>
    </div>
    <div class="modal-body" id="modal-body">
      <div id="progress-bar" class="progress" style="width:400px;margin:0 auto">
        <div id="progress-bar-info" class="progress-bar progress-bar-info" style="transition: all 3s;"></div>
      </div>

      <iframe ng-src="{{cleanUrl()}}" id="myframe" onload="frameLoaded();" style="display:none;border:none;width:400px;height:300px;margin:0 auto"></iframe>

    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-default" ng-click="dismiss()">Close</button>
    </div>
  </script>

    <script type="text/ng-template" id="myMapperContent.html">
      <div class="modal-header">
        <button type="button" class="close" ng-click="ok()">&times;</button>
        <h4 class="modal-title">Image Mapping Tool</h4>
      </div>
      <div class="modal-body">
        <div id="wrapper" class="wrapper">
          <header id="header" class="header">
            <nav id="nav" class="clearfix nav">
              <ul>
                <li id="rect" class="rect"><a class="btn btn-default" href="#">rectangle</a></li>
                <li id="circle" class="circle"><a class="btn btn-default" href="#">circle</a></li>
                <li id="polygon" class="polygon"><a class="btn btn-default" href="#">polygon</a></li>
                <li id="edit" class="edit"><a class="btn btn-default" href="#">edit</a></li>
                <li id="del_btn" class="del_btn"><a class="btn btn-warning" href="#">delete</a></li>
                <li id="clear" class="clear"><a class="btn btn-primary" href="#">clear</a></li>


              </ul>
            </nav>
            <div id="coords" class="coords"></div>
            <div id="debug" class="debug"></div>
          </header>
          <div id="image_wrapper" class="image_wrapper">
            <div id="image" class="img-map-container">
              <img src="" alt="#" id="img" class="img"/>
              <svg xmlns="http://www.w3.org/2000/svg" version="1.2" baseProfile="tiny" id="svg" class="svg"></svg>
            </div>
          </div>
        </div>

        <!-- For html image map code -->
        <div id="code" class="code">
          <span class="close_button" title="close"></span>
          <div id="code_content" class="code_content"></div>
        </div>

        <!-- Edit details block -->
        <div id="edit_details" class="edit_details">
          <h5 id="h5" class="h5">Attributes</h5>
          <span id="close_button" class="close_button" title="close"></span>
          <p>
            <label for="href_attr">href</label>
            <input type="text" id="href_attr" class="href_attr" />
          </p>
          <p>
            <label for="mlink_attr">Tracking ID</label>
            <input type="text" id="mlink_attr" class="mlink_attr" />
          </p>
          <p>
            <label for="alt_attr">alt</label>
            <input type="text" id="alt_attr" class="alt_attr"/>
          </p>
          <p>
            <label for="title_attr">title</label>
            <input type="text" id="title_attr" class="title_attr"/>
          </p>
          <button id="save_details" class="save_details btn btn-success">Save</button>

        </div>

        <!-- From html block -->
        <div id="from_html_wrapper" class="from_html_wrapper" ng-app="JSConfigApp">
          <form id="from_html_form" class="from_html_form">
            <h5>Loading areas</h5>
            <span class="close_button" title="close"></span>
            <p>
              <label for="code_input">Enter your html code:</label>
              <textarea id="code_input" class="code_input" ng-model="imageMap">{{imageMap}}</textarea>
            </p>
            <button id="load_code_button" class="load_code_button">Load</button>
          </form>
        </div>

        <!-- Get image form -->
        <div id="get_image_wrapper" class="get_image_wrapper">
          <div id="get_image" class="get_image">
            <div id="loading" class="loading">Loading</div>
            <div id="file_reader_support" class="file_reader_support">
              <div id="dropzone" class="dropzone">
                <span class="clear_button" title="clear">x</span>
                <img src alt="preview" id="sm_img" class="sm_img" />
              </div>
            </div>
            <label for="url">type a url</label>
            <span id="url_wrapper" class="url_wrapper">
              <span class="clear_button" title="clear">x</span>
            <input type="text" id="url" class="url" />
            </span>
            <button id="button" class="button" dataUri="promo.bannerContent.img.images.dataUri">OK</button>
          </div>
        </div>

        <!-- Help block -->
        <div id="overlay" class="overlay"></div>
        <div id="help" class="help">
          <span class="close_button" title="close"></span>
          <div class="txt">
            <section>
              <h2>Main</h2>
              <p><span class="key">F5</span> &mdash; reload the page and display the form for loading image again</p>
              <p><span class="key">S</span> &mdash; save map params in localStorage</p>
            </section>
            <section>
              <h2>Drawing mode (rectangle / circle / polygon)</h2>
              <p><span class="key">ENTER</span> &mdash; stop polygon drawing (or click on first helper)</p>
              <p><span class="key">ESC</span> &mdash; cancel drawing of a new area</p>
              <p><span class="key">SHIFT</span> &mdash; square drawing in case of a rectangle and right angle drawing in case of a polygon</p>
            </section>
            <section>
              <h2>Editing mode</h2>
              <p><span class="key">DELETE</span> &mdash; remove a selected area</p>
              <p><span class="key">ESC</span> &mdash; cancel editing of a selected area</p>
              <p><span class="key">SHIFT</span> &mdash; edit and save proportions for rectangle</p>
              <p><span class="key">I</span> &mdash; edit attributes of a selected area (or dblclick on an area)</p>
              <p><span class="key">CTRL</span> + <span class="key">C</span> &mdash; a copy of the selected area</p>
              <p><span class="key">&uarr;</span> &mdash; move a selected area up</p>
              <p><span class="key">&darr;</span> &mdash; move a selected area down</p>
              <p><span class="key">&larr;</span> &mdash; move a selected area to the left</p>
              <p><span class="key">&rarr;</span> &mdash; move a selected area to the right</p>
            </section>
          </div>
          <footer>

          </footer>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" ng-click="ok()">Close</button>
      </div>

      </script>



  <script src="js/angular-animate-1.5.0.js"></script>
  <script src="js/angular-touch-1.5.0.js"></script>
  <script src="js/angular-spectrum-colorpicker.min.js"></script>
  <script src="js/spectrum.js"></script>
  <script src="js/textAngular-dropdownToggle.js"></script>
  <script src='js/textAngular-rangy.min.js'></script>
  <script src='js/textAngular-sanitize.min.js'></script>
  <script src="js/textAngularSetup-beta.js"></script>
  <script src='js/textAngular.js'></script>

  <script src='js/img-mapper.js'></script>


  <script>
    //angular.module('JSConfigApp', ['ngAnimate', 'ui.bootstrap']);
    var JSConfigApp = angular.module('JSConfigApp', ['textAngular','ngAnimate','ui.bootstrap']).controller('JSConfigAppCtrl', ['$scope', '$uibModal', '$sce', function($scope, $uibModal, $sce) {

      $scope.brandChoices = ["ON","BR","GAP","AT"];
      $scope.assignedBrand = "ON";

      $scope.brandUpdate = function(brand) {
        var cssUpdate = brand+"-style";
        var elList = document.getElementsByClassName('html-banner-branded');
        for (x=0;x<elList.length;x++) {
          var classList = elList[x].className.split(/\s+/);
          for (y=0;y<classList.length;y++) {
            if (classList[y].match(/style/)) {
              jQuery('.html-banner-branded').removeClass(classList[y])
            }
          }
        }
        jQuery(".html-banner-branded").addClass(cssUpdate);
      }
      //globals
      var cellOuterWidth;
      var fullSliderContainerWidth;
      $scope.pageNumber = 0;
      $scope.setPageNumber = function(index) {
        $scope.pageNumber = index;
      }

      // this object has all the parameters for our drawer
      $scope.promos = {
        global: {
          launchDate: "",
          headerText: "",
          subHeaderText: "",
          promos: [{
            bannerContent: {
              imgOrHTML: "img",
              img: {
                contentParameters: {
                  linkType : false,
                  imageMap: ""
                },
                images: {
                  path: "",
                  dataUri: ""
                }
              },
              HTML: {
                useLocal: true,
                localHTML: '<h1 style="text-align: center;">Headline</h1>\
    <h2 style="text-align: center;">Subheader</h2>\
    <p style="text-align: center;">Some optional info</p>\
    <p style="text-align: center;">\
    <a href="/category.html" target="">Link 1</a>&nbsp;\
    <a href="/cat.html">Link 2</a>\
    </p>',
                backgroundColor: "#FFFFFF",
                css: "",
                path: ""
              }
            },
            tapContent: {
              displayType       : "generic",
              legalOverride     : "",
              redeemMessage     : "Use code <generic> at checkout",
              useLegalOverride  : false,
              genericCodeId     : "",
              genericCode       : "",
              popupTextLink     : "DETAILS"
            }
          }]
        }
      }

      $scope.delete = function(idx) {
        $scope.promos.global.promos.splice(idx, 1);
        fullSliderContainerWidth = cellOuterWidth * $scope.promos.global.promos.length;
        jQuery(".offerspotlight-drawer-slider-items").css('width', fullSliderContainerWidth + "px");
      };

      $scope.moveCell = function(old_index, dir) {
        var new_index = old_index + dir;
        if (new_index >= $scope.promos.global.promos.length) {
          var k = new_index - $scope.promos.global.promos.length;
          while ((k--) + 1) {
            $scope.promos.global.promos.push(undefined);
          }
        }
        $scope.promos.global.promos.splice(new_index, 0, $scope.promos.global.promos.splice(old_index, 1)[0]);
        //return this; // for testing purposes
      };


      $scope.addItem = function() {
        $scope.promos.global.promos.push({
          bannerContent: {
            imgOrHTML: "img",
            img: {
              contentParameters: {
                linkType : false,
                imageMap: ""
              },
              images: {
                path: "",
                dataUri: ""
              }
            },
            HTML: {
              useLocal: true,
              localHTML: '<h1 style="text-align: center;">Headline</h1>\
  <h2 style="text-align: center;">Subheader</h2>\
  <p style="text-align: center;">Some optional info</p>\
  <p style="text-align: center;">\
  <a href="/category.html" target="">Link 1</a>&nbsp;\
  <a href="/cat.html">Link 2</a>\
  </p>',
              backgroundColor: "#FFFFFF",
              css: "",
              path: ""
            }
          },
          tapContent: {
            displayType       : "generic",
            legalOverride     : "",
            redeemMessage     : "Use code <generic> at checkout",
            useLegalOverride  : false,
            genericCodeId     : "",
            genericCode       : "",
            popupTextLink     : "DETAILS"
          }
        });
        cellOuterWidth = jQuery(".offerspotlight-drawer-slider-item").outerWidth(true);
        fullSliderContainerWidth = cellOuterWidth * $scope.promos.global.promos.length;
        jQuery(".offerspotlight-drawer-slider-items").css('width', fullSliderContainerWidth + "px");
      };

      // experimental function for pulling in PPC iframe to ensure accurate code is chosen
      $scope.cleanUrl = function(index) {
        return $sce.trustAsResourceUrl("https://secure.www.brol.wip.gidapps.com/buy/promo_legal_details.do?promoId=" + $scope.promos.global.promos[index].tapContent.genericCodeId);
      }


      // This section deals with importing a json file and then building out our global
      // configuration and updating the view.

      jQuery("#the-file-input").change(function() {
        $scope.renderJSON(this.files[0]);
      });

      $scope.renderJSON = function(file) {
        var fr = new FileReader();
        fr.onload = function(e) {

          // this removes the jsonp callback stuff
          var newArr = JSON.parse(e.target.result.substring(e.target.result.indexOf('{'), e.target.result.lastIndexOf(');')));
          $scope.$apply($scope.promos = newArr);
          setTimeout(function(){
            cellOuterWidth = jQuery(".offerspotlight-drawer-slider-item").outerWidth(true);
            fullSliderContainerWidth = cellOuterWidth * $scope.promos.global.promos.length;
            jQuery(".offerspotlight-drawer-slider-items").css('width', fullSliderContainerWidth + "px");
            jQuery('.redeem').on('click', function() {
              jQuery(this).toggleClass('applied');
              jQuery(this).toggleText('Applied At Bag', 'Redeem Now')
              return false;
            });
          }, 300);
        }
        fr.readAsText(file);
      }

      // JSON export function
      $scope.myEncodeJson = function(obj) {
        newObj = this.stripClone(obj);
        var stringedJSON = "promoObjCallback(" + JSON.stringify(newObj) + ");";
        return stringedJSON;
      };

      $scope.stripClone = function(obj) {
        if (null == obj || "object" != typeof obj) return obj;
        var copy = obj.constructor();
        for (var attr in obj) {
          if (obj.hasOwnProperty(attr) && attr != '$$hashKey') {
            var obj_attr = obj[attr];
            if (typeof obj_attr == "object") {
              copy[attr] = this.stripClone(obj_attr);
            } else if (typeof obj_attr == "array") {
              copy[attr] = [];
              for (var i = 0; i < obj_attr.length; i++) {
                copy[attr].push(this.stripClone(obj_attr));
              }
            } else {
              copy[attr] = obj_attr;
            }
          }
        }
        return copy;
      };


      // load up an image and convert it to a dataURI
      jQuery(document).on('change', '#the-img-input', function() {
        $scope.renderURI(this, function(dataUri) {
          $scope.$apply($scope.promos.global.promos[$scope.pageNumber].bannerContent.img.images.dataUri = dataUri);
        });
      });

      $scope.renderURI = function(input, callback) {
        var image = new Image();
        image.onload = function() {
          var canvas = document.createElement('canvas');
          canvas.width = this.naturalWidth; // or 'width' if you want a special/scaled size
          canvas.height = this.naturalHeight; // or 'height' if you want a special/scaled size
          canvas.getContext('2d').drawImage(this, 0, 0);
          $scope.imgError = "";
          if (canvas.width != 331 && canvas.height != 183) {
            $scope.imgError = 'Your image is ' + canvas.width + ' pixels wide by ' + canvas.height + ' pixels high. Recommended dimensions are 600 pixels wide by 332 pixels high. Your image may be distorted.';
          }

          callback(canvas.toDataURL('image/jpeg').replace(/^data:image\/(png|jpg);base64,/, ''));

        };

        if (input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function(e) {
            image.src = e.target.result;
          }
          reader.readAsDataURL(input.files[0]);
        }
      }

      $scope.erasePic = function(index) {
        $scope.promos.global.promos[index].bannerContent.img.images.dataUri = "";
        var el = document.getElementsByClassName('bannerimg');
        console.log(el[index])
        $(el[index]).attr("src","");
      }


      // handle the changing of the background in editor and preview
      $scope.bgColorChange = function(index) {
        jQuery('.ta-text:eq("' + index + '"), .html-preview:eq("' + index + '")').css('background-color', $scope.promos.global.promos[index].bannerContent.HTML.backgroundColor);
      }

      // attach event to tap to apply button
      $scope.attachRedeem = function() {
        jQuery('.redeem').on('click', function() {
          jQuery(this).toggleClass('applied');
          jQuery(this).toggleText('Applied At Bag', 'TAP TO APPLY')
          return false;
        });
      }

      $scope.mapImgModal = function(index, dataURI, mapHTML){
        var el = document.getElementsByClassName('mapCode')[index];
        mapHTML = el.value;
        var modalInstance = $uibModal.open({
          animation: $scope.animationsEnabled,
          templateUrl: 'myMapperContent.html',
          controller: 'ModalInstanceCtrl',
          size: 'lg',
          resolve: {
            index : function() {
              return index;
            },
            imageMapCode: function () {
              return $scope.promos.global.promos[index].bannerContent.img.contentParameters.imageMap;
            }
          }
        })
        modalInstance.rendered
          .then(function() {

            var imageMap = $scope.promos.global.promos[index].bannerContent.img.contentParameters.imageMap;

            imageMapper(index, dataURI, imageMap);
          })
        modalInstance.result
          .then(function (result) {
            index = results[1];
            mapValue = results[0];

            $scope.promos.global.promos[index].bannerContent.img.contentParameters.imageMap = mapValue;
          })
      }

      $scope.ppcCheckModal = function(ppcId, index, brand){
        var modalInstance = $uibModal.open({
          animation: $scope.animationsEnabled,
          templateUrl: 'ppcCodeCheck.html',
          controller: 'ppcModalInstanceCtrl',
          size: 'md',
          resolve: {
            ppcId: function () {
              return $scope.promos.global.promos[index].tapContent.genericCodeId;
            },
            brand: function () {
              return brand;
            }
          }
        })
        modalInstance.rendered
          .then(function() {
            jQuery("#progress-bar-info").css('width','100%')
        })
      }
    }]);

      angular.module('JSConfigApp').controller('ppcModalInstanceCtrl', function ($scope, $sce, $uibModalInstance, ppcId, brand) {

        $scope.ppcId = ppcId;
        $scope.brand = brand;

        $scope.cleanUrl = function() {
          return $sce.trustAsResourceUrl("http://"+brand+".gap.com/buy/promo_legal_details.do?promoId="+ppcId);
        }

        $scope.dismiss = function () {
          jQuery("#progress-bar").css('display','block');
          jQuery("#myframe").css('display','none');
          jQuery("#progress-bar-info").css('width','0%')

          $uibModalInstance.dismiss();
        };
      });

      angular.module('JSConfigApp').controller('ModalInstanceCtrl', function ($scope, $uibModalInstance, index, imageMapCode) {

        $scope.imageMap = imageMapCode;

        $scope.ok = function () {
          map = document.getElementsByClassName('code_content');
          $scope.imageMap = map[0].innerHTML//.replace('&lt;',/</).replace('&gt;',/>/);

          results = [$scope.imageMap, index]
          $uibModalInstance.close(results);
        };
        $scope.cancel = function () {
          $uibModalInstance.dismiss();
        };
      });

      JSConfigApp.config(['$compileProvider', function($compileProvider) {
        $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file|data|blob):/);
      }]);





      function frameLoaded() {
        setTimeout(function(){
          jQuery("#progress-bar").css('display','none');jQuery("#myframe").css('display','block');
        }, 3000);
      }


    jQuery.fn.toggleText = function(t1, t2) {
      if (this.text() == t1) this.text(t2);
      else this.text(t1);
      return this;
    };
  </script>
</body>
</html>
