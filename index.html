<!DOCTYPE html>
<html ng-app="JSConfigApp"> 

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/bootstrap.min.css">

  <!-- inportant: this css should remain linked by brand -->
  <link rel="stylesheet" href="css/spotlight-drawer.css">

  <link rel="stylesheet" href="brand-css-files/br-style.css">
  <link rel="stylesheet" href="css/textAngular.css">
  <link rel="stylesheet" href="css/font-awesome.min.css">
  <link rel="stylesheet" href="css/spectrum.min.css" />
  <link rel="stylesheet" href="css/image-mapper-main.css" />
</head>
<style>
  .drawer-item {
    margin-bottom: 22px;
  }

  .hidden {
    display: none;
  }

  .btn-file {
    position: relative;
    overflow: hidden;
  }

  .btn-file input[type=file] {
    position: absolute;
    top: 0;
    right: 0;
    min-width: 100%;
    min-height: 100%;
    font-size: 100px;
    text-align: right;
    filter: alpha(opacity=0);
    opacity: 0;
    outline: none;
    background: white;
    cursor: inherit;
    display: block;
  }

  .full-spectrum .sp-palette {
    max-width: 200px;
  }

  .btn-blue {
    border-color: #000;
    border: 1px solid rgba(0, 0, 0, 0.13);
  }

  .btn-toolbar>.btn-group {
    margin-bottom: 12px;
  }

  [ta-button] {
    height: 44px;
    margin-bottom: 5px;
  }
</style>

<body ng-controller="JSConfigAppCtrl">
  <div class="container">
    <div class="row">
      <div class="col-sm-8">
        <h1>Promo Drawer Configuration Tool v6</h1>
      </div>
      <div class="col-sm-4">
      </div>
    </div>
    <form name="cellForm" ng-submit="submitForm(cellForm.$valid)" novalidate>
      <div class="row">
        <div class="col-sm-12">
          <div class="form-group" ng-class="{ 'has-error' : cellForm.headerText.$invalid && !cellForm.headerText.$pristine }">
            <label for="headerText">Drawer Header Text</label>
            <input type="text" name="headerText" class="form-control" ng-model="promos.global.headerText" id="headerText" placeholder="Enter Header Text" required ng-minlength="1" ng-maxlength="24">
            <p ng-show="cellForm.headerText.$error.minlength" class="help-block">Minimum of 1 character.</p>
            <p ng-show="cellForm.headerText.$error.maxlength" class="help-block">24 characters maximum.</p>
          </div>
          <div class="form-group">
            <label for="headerSubText">Drawer Header Sub Text</label>
            <input type="text" class="form-control" ng-model="promos.global.subHeaderText" id="headerSubText" placeholder="Enter Header Sub Text">
          </div>
        </div>
      </div>
      <div class="row" ng-repeat="promo in promos.global.promos track by $index">
        <div class="col-sm-12">
          <div class="panel panel-info">
            <div class="panel-heading">
              <h2 class="panel-title">Drawer Cell {{$index + 1}}
							  <button
							    ng-show="promos.global.promos.length > 1"
							    style="margin-left:12px;line-height:18px;"
							    ng-click="moveCell($index,1)"
							    class="btn btn-info btn-xs fa fa-arrow-circle-down">
							  </button>
							  <button
							    ng-show="promos.global.promos.length > 1"
							    style="margin-left:12px;line-height:18px;"
							    ng-click="moveCell($index,-1)"
							    class="btn btn-info btn-xs fa fa-arrow-circle-up">
							  </button>
                <button
                  ng-show="promos.global.promos.length > 1"
                  class="btn pull-right btn-info btn-xs fa fa-times"
                  ng-click="delete($index)">
							  </button>
							</h2>
            </div>
            <div class="panel-body">
              <div class="col-sm-7">
                <div class="panel panel-default">
                  <div class="panel-heading">Banner Content</div>
                  <div class="panel-body">
                    <div class="col-sm-12">
                      <div class="form-group">
                        <div class="radio">
                          <label class="radio-inline">
                            <input type="radio" ng-model="promo.bannerContent.imgOrHTML" value="img" name="group_{{$index}}">
                            <strong>Image</strong> - Cell loads an image with options for a single link, image mapping or no link.
                          </label>
                        </div>
                        <div class="radio">
                          <label class="radio-inline">
                            <input type="radio" ng-model="promo.bannerContent.imgOrHTML" value="html" name="group_{{$index}}">
                            <strong>HTML</strong> - cell loads HTML content or iframe to display advanced messaging
                          </label>
                        </div>
                      </div>
                      <div class="img-container" ng-show="promo.bannerContent.imgOrHTML == 'img'">
                        <div class="form-group">
                          <span class="btn btn-success btn-file" ng-hide="promo.bannerContent.img.images.dataUri">
														Import jpg (331w x 183h, 48kb max) <input id="the-img-input" ng-click="setPageNumber($index)" type="file" >
													</span>
                          <button class="btn btn-danger" ng-click="erasePic($index)" ng-show="promo.bannerContent.img.images.dataUri">Delete image</button>
                        </div>
                        <div class="form-group" ng-show="promo.bannerContent.img.images.dataUri">
                          <img data-ng-src="{{promo.bannerContent.img.images.dataUri}}" class="img-responsive">
                          <div style="margin-top:15px;" class="alert alert-warning" ng-show="imgError">
                            <h4>Warning!</h4>
                            <p>{{imgError}}</p>
                          </div>
                        </div>
                        <div class="form-group" ng-hide="promo.bannerContent.img.images.dataUri">
                          <label for="inputImageUrl">Cell image path</label>
                          <input type="text" ng-model="promo.bannerContent.img.images.path" class="form-control" id="inputImageUrl" placeholder="URL">
                        </div>
                        <div class="form-group" ng-show="promo.bannerContent.img.images.dataUri">
                          <div class="checkbox">
                            <label>
                              <input type="checkbox" ng-model="promo.bannerContent.img.contentParameters.link"> Link image</input>
                            </label>
                          </div>
                          <div class="checkbox">
                            <label>
                              <input type="checkbox" ng-model="promo.bannerContent.img.contentParameters.useMap"> Map image</input>
                            </label>
                          </div>
                          <textarea ng-show="promo.bannerContent.img.contentParameters.useMap" class="form-control" rows="3" id="textArea" ng-model="promo.bannerContent.img.contentParameters.imageMap" placeholder="paste image map data here"></textarea>
                          <br>
                          <button id="mapButton" dataUri="{{promo.bannerContent.img.images.dataUri}}" ng-show="promo.bannerContent.img.contentParameters.useMap" type="button" class="btn btn-info" data-toggle="modal" data-target="#myModal">Map Image</button>
                          <div id="myModal" class="modal fade" role="dialog">
                            <div class="modal-dialog modal-lg">

                              <!-- Modal content-->
                              <div class="modal-content">
                                <div class="modal-header">
                                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                                  <h4 class="modal-title">Image Mapping Tool</h4>
                                </div>
                                <div class="modal-body">
                                  <div id="wrapper">
                                    <header id="header">
                                      <nav id="nav" class="clearfix">
                                        <ul>
                                          <li id="save"><a href="#">save</a></li>
                                          <li id="load"><a href="#">load</a></li>
                                          <li id="from_html"><a href="#">from html</a></li>
                                          <li id="rect"><a href="#">rectangle</a></li>
                                          <li id="circle"><a href="#">circle</a></li>
                                          <li id="polygon"><a href="#">polygon</a></li>
                                          <li id="edit"><a href="#">edit</a></li>
                                          <li id="to_html"><a href="#">to html</a></li>
                                          <li id="preview"><a href="#">preview</a></li>
                                          <li id="clear"><a href="#">clear</a></li>
                                          <li id="new_image"><a href="#">new image</a></li>
                                          <li id="show_help"><a href="#">?</a></li>
                                        </ul>
                                      </nav>
                                      <div id="coords"></div>
                                      <div id="debug"></div>
                                    </header>
                                    <div id="image_wrapper">
                                      <div id="image">
                                        <img src="" alt="#" id="img" />
                                        <svg xmlns="http://www.w3.org/2000/svg" version="1.2" baseProfile="tiny" id="svg"></svg>
                                      </div>
                                    </div>
                                  </div>

                                  <!-- For html image map code -->
                                  <div id="code">
                                    <span class="close_button" title="close"></span>
                                    <div id="code_content"></div>
                                  </div>

                                  <!-- Edit details block -->
                                  <div id="edit_details">
                                    <h5 id="h5">Attrubutes</h5>
                                    <span id="close_button" class="close_button" title="close"></span>
                                    <p>
                                      <label for="href_attr">href</label>
                                      <input type="text" id="href_attr" />
                                    </p>
                                    <p>
                                      <label for="alt_attr">alt</label>
                                      <input type="text" id="alt_attr" />
                                    </p>
                                    <p>
                                      <label for="title_attr">title</label>
                                      <input type="text" id="title_attr" />
                                    </p>
                                    <button id="save_details">Save</button>
                                  </div>

                                  <!-- From html block -->
                                  <div id="from_html_wrapper">
                                    <form id="from_html_form">
                                      <h5>Loading areas</h5>
                                      <span class="close_button" title="close"></span>
                                      <p>
                                        <label for="code_input">Enter your html code:</label>
                                        <textarea id="code_input"></textarea>
                                      </p>
                                      <button id="load_code_button">Load</button>
                                    </form>
                                  </div>

                                  <!-- Get image form -->
                                  <div id="get_image_wrapper">
                                    <div id="get_image">
                                      <div id="loading">Loading</div>
                                      <div id="file_reader_support">
                                        <div id="dropzone">
                                          <span class="clear_button" title="clear">x</span>
                                          <img src alt="preview" id="sm_img" />
                                        </div>
                                      </div>
                                      <label for="url">type a url</label>
                                      <span id="url_wrapper">
																				<span class="clear_button" title="clear">x</span>
                                      <input type="text" id="url" />
                                      </span>
                                      <button id="button" dataUri="promo.bannerContent.img.images.dataUri">OK</button>
                                    </div>
                                  </div>

                                  <!-- Help block -->
                                  <div id="overlay"></div>
                                  <div id="help">
                                    <span class="close_button" title="close"></span>
                                    <div class="txt">
                                      <section>
                                        <h2>Main</h2>
                                        <p><span class="key">F5</span> &mdash; reload the page and display the form for loading image again</p>
                                        <p><span class="key">S</span> &mdash; save map params in localStorage</p>
                                      </section>
                                      <section>
                                        <h2>Drawing mode (rectangle / circle / polygon)</h2>
                                        <p><span class="key">ENTER</span> &mdash; stop polygon drawing (or click on first helper)</p>
                                        <p><span class="key">ESC</span> &mdash; cancel drawing of a new area</p>
                                        <p><span class="key">SHIFT</span> &mdash; square drawing in case of a rectangle and right angle drawing in case of a polygon</p>
                                      </section>
                                      <section>
                                        <h2>Editing mode</h2>
                                        <p><span class="key">DELETE</span> &mdash; remove a selected area</p>
                                        <p><span class="key">ESC</span> &mdash; cancel editing of a selected area</p>
                                        <p><span class="key">SHIFT</span> &mdash; edit and save proportions for rectangle</p>
                                        <p><span class="key">I</span> &mdash; edit attributes of a selected area (or dblclick on an area)</p>
                                        <p><span class="key">CTRL</span> + <span class="key">C</span> &mdash; a copy of the selected area</p>
                                        <p><span class="key">&uarr;</span> &mdash; move a selected area up</p>
                                        <p><span class="key">&darr;</span> &mdash; move a selected area down</p>
                                        <p><span class="key">&larr;</span> &mdash; move a selected area to the left</p>
                                        <p><span class="key">&rarr;</span> &mdash; move a selected area to the right</p>
                                      </section>
                                    </div>
                                    <footer>
                                      <a href="http://github.com/summerstyle/summer">Summer html image map creator 0.5</a>
                                      <br /> &copy; 2014 Vera Lobatcheva
                                      <br /> GPL3 License
                                    </footer>
                                  </div>

                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                </div>
                              </div>

                            </div>
                          </div>
                        </div>

                        <div class="form-group" ng-show="promo.bannerContent.img.contentParameters.link == true">
                          <label for="inputUrl">Cell link URL</label>
                          <input ng-model="promo.bannerContent.img.contentParameters.linkUrl" type="text" class="form-control" id="inputUrl" placeholder="URL">
                        </div>
                      </div>

                      <div class="HTML-container" ng-show="promo.bannerContent.imgOrHTML == 'html'">
                        <div class="form-group">
                          <label>
                            <input type="checkbox" ng-model="promo.bannerContent.HTML.useLocal"> Generate HTML
                          </label>
                        </div>
                        <div class="form-group" ng-hide="promo.bannerContent.HTML.useLocal">
                          <label for="inputImageUrl">HTML path</label>
                          <input type="text" ng-model="promo.bannerContent.HTML.path" class="form-control" placeholder="URL">
                        </div>
                        <div class="form-group" ng-show="promo.bannerContent.HTML.useLocal">
                          <label for="html">HTML Content</label>
                          <text-angular ng-model="promo.bannerContent.HTML.localHTML" class="html-banner-br"></text-angular>
                        </div>
                        <div class="form-group" ng-show="promo.bannerContent.HTML.useLocal">
                          <label for="bgcolor">Background Color</label>
                          <br>
                          <spectrum-colorpicker name="bgcolor" ng-model="promo.bannerContent.HTML.backgroundColor" format="'hex'" class="bg-colorpicker" on-change="bgColorChange($index)" options="{replacerClassName: 'fa fa-eyedropper', showButtons: true, showInput: true, preferredFormat: 'hex'}"></spectrum-colorpicker>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-5">
                <div class="panel panel-default">
                  <div class="panel-heading">Banner Footer</div>
                  <div class="panel-body">
                    <div class="form-group">
                      <div class="radio">
                        <label class="radio-inline">
                          <input type="radio" ng-model="promo.tapContent.displayType" value="generic" name="tapType_{{$index}}">
                          <strong>Generic</strong> - display generic code
                        </label>
                      </div>
                      <div class="radio">
                        <label class="radio-inline">
                          <input type="radio" ng-model="promo.tapContent.displayType" value="tap" name="tapType_{{$index}}" ng-change="attachRedeem()">
                          <strong>Tap to apply</strong> - display a "redeem now" button which applies the code
                        </label>
                      </div>
                      <div class="radio">
                        <label class="radio-inline">
                          <input type="radio" ng-model="promo.tapContent.displayType" value="none" name="tapType_{{$index}}">
                          <strong>None</strong> - display "No code required"
                        </label>
                      </div>
                    </div>
                    <form class="form">
                      <div class="form-group" ng-hide="promo.tapContent.displayType == 'none'" ng-class="{ 'has-error' : cellForm.genericCodeId.$invalid && !cellForm.genericCodeId.$pristine }">
                        <label for="genericCodeId">PPC ID</label>
                        <input type="text" name="genericCodeId" ng-model="promo.tapContent.genericCodeId" class="form-control" id="genericCodeId" ng-pattern="/^[0-9]*$/" placeholder="123456">
                        <p ng-show="cellForm.genericCodeId.$error.pattern" class="help-block">Only numbers are allowed.</p>
                      </div>

                      <div class="form-group" ng-hide="promo.tapContent.displayType == 'none'">
                        <label for="genericCode">Generic code</label>
                        <input name="genericCode" type="text" ng-model="promo.tapContent.genericCode" class="form-control" id="genericCode" placeholder="SAVENOW">
                      </div>
                    </form>
                    <div class="form-group">
                      <label>
                        <input type="checkbox" ng-model="promo.tapContent.useLegalOverride"> Override Legal Text? If unchecked, legal will be pulled from PPC through ecom if a PPC code is in use.
                      </label>
                    </div>
                    <div class="form-group" ng-show="promo.tapContent.useLegalOverride">
                      <label for="inputUrl">Legal popup text override</label>
                      <textarea class="form-control" rows="3" id="textArea" ng-model="promo.tapContent.legalOverride" placeholder="Manually written legal"></textarea>
                    </div>
                    <div class="form-group" ng-show="promo.tapContent.genericCode && promo.tapContent.genericCodeId && promo.tapContent.displayType != 'none'">
                      <label for="preview">iframe preview</label>
                      <!-- <iframe name="preview" frameborder="0" scrolling="yes" ng-src="{{cleanUrl($index)}}"></iframe> -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-sm-12">
          <button style="margin-bottom: 22px;" class="btn btn-success pull-right" ng-click="addItem()">Add promo cell</button>
          <br>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-3">
        </div>
        <div class="col-sm-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h2 class="panel-title">Preview : Iphone 4 resolution</h2>
            </div>
            <div class="panel-body" style="width:350px;margin:15px auto; border: 1px solid #ddd;background:black;">
              <span class="label label-danger" ng-hide="promos.global.headerText">No header defined</span>
              <span class="offerspotlight-title-text">{{promos.global.headerText}}</span>
              <br>
              <span class="label label-danger" ng-hide="promos.global.subHeaderText">No subheader defined</span>
              <span class="offerspotlight-title-subtext">{{promos.global.subHeaderText}}</span>
              <div class="offerspotlight-drawer" style="position:relative!important;">
                <div class="offerspotlight-drawer-slider">
                  <div class="offerspotlight-drawer-slider-items">
                    <div class="offerspotlight-drawer-slider-item" ng-repeat="promo in promos.global.promos track by $index" ng-show="promo.bannerContent.img.images.path || promo.bannerContent.img.images.dataUri || promo.bannerContent.HTML.path || promo.bannerContent.HTML.useLocal">
                      <div class="item-banner-content" ng-show="promo.bannerContent.imgOrHTML == 'html' && promo.bannerContent.HTML.useLocal">
                        <div style="vertical-align:middle;width:256px;height:142px;border:1px solid #AAA;-moz-box-sizing:border-box;-webkit-box-sizing: border-box;box-sizing:border-box;">
                          <div ng-bind-html="promo.bannerContent.HTML.localHTML" class="html-banner-br html-preview" style="height:100%">
                          </div>
                        </div>
                      </div>
                      <div class="item-banner-content" ng-show="promo.bannerContent.imgOrHTML == 'html' && !promo.bannerContent.HTML.useLocal">
                        <iframe frameborder="0" scrolling="no" style="width:256px;height:142px;" ng-src="{{promo.bannerContent.HTML.path}}"></iframe>
                      </div>
                      <div class="item-banner-content" ng-show="promo.bannerContent.imgOrHTML == 'img'">
                        <a ng-href="{{promo.bannerContent.img.contentParameters.linkUrl}}" ng-show="promo.bannerContent.img.contentParameters.link">
                          <img width="256" height="142" class="bannerimg" data-ng-src="{{promo.bannerContent.img.images.dataUri}}" ng-hide="!promo.bannerContent.img.images.dataUri">
                          <img width="256" height="142" class="bannerimg" ng-src="{{promo.bannerContent.img.images.path}}" ng-hide="!promo.bannerContent.img.images.path">
                        </a>
                        <img width="256" height="142" class="bannerimg" data-ng-src="{{promo.bannerContent.img.images.dataUri}}" ng-hide="!promo.bannerContent.img.images.dataUri || promo.bannerContent.img.contentParameters.link">
                        <img width="256" height="142" class="bannerimg" ng-src="{{promo.bannerContent.img.images.path}}" ng-hide="!promo.bannerContent.img.images.path || promo.bannerContent.img.contentParameters.link">
                      </div>
                      <div class="spotlight-footer">
                        <div class="control-code column1" ng-hide="promo.tapContent.displayType == 'none'">
                          <a href="#" class="redeem" ng-show="promo.tapContent.displayType == 'tap'">TAP TO APPLY</a>
                          <span class="gen" ng-show="promo.tapContent.displayType == 'generic'">Enter <span class="strong">{{promo.tapContent.genericCode}}</span>
                          <br> at checkout</span>
                          <span class="none" ng-show="promo.tapContent.displayType == 'none'">NO CODE REQUIRED</span>
                        </div>
                        <div class="control-apply column2">
                          <a href="#normal" class="legal-details">
                            <span class="legal">details</span>
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-3">
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <div class="panel panel-default">
            <div class="panel-body">
              <div class="col-sm-6">
                <span class="btn btn-default btn-block btn-file">
									Import config.json file <input id="the-file-input" type="file">
								</span>
              </div>
              <div class="col-sm-6">
                <a download="config.json" class="btn btn-primary btn-block" role="button" ng-href="data:text/json;charset=utf-8,{{myEncodeJson(promos)}}">Export config.json file</a>
              </div>
            </div>
          </div>
        </div>
      </div>


			<div class="row">
				<div class="col-sm-12">
					<div class="panel panel-default">
					<div class="panel-heading">Output</div>
					<div class="panel-body"><code>{{promos}}</code></div>
				</div>
				</div>
			</div>


      <div class="row">
        <div class="col-sm-12"></div>
      </div>
  </div>
  </form>
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>

  <script src="js/jquery-2.2.1.min.js"></script>

<script src="js/angular.min.js"></script>
  <script src="js/angular-spectrum-colorpicker.min.js"></script>
  <script src="js/spectrum.js"></script>

  <script src="js/textAngular-dropdownToggle.js"></script>
  <script src='js/textAngular-rangy.min.js'></script>
  <script src='js/img-mapper.js'></script>
  <script>
    ! function(a, b) {
      b["true"] = a,
        /**
         * @license AngularJS v1.3.10
         * (c) 2010-2014 Google, Inc. http://angularjs.org
         * License: MIT
         */
        function(a, b, c) {
          "use strict";

          function d() {
            this.$get = ["$$sanitizeUri", function(a) {
              return function(b) {
                "undefined" != typeof arguments[1] && (arguments[1].version = "taSanitize");
                var c = [];
                return g(b, l(c, function(b, c) {
                  return !/^unsafe/.test(a(b, c))
                })), c.join("")
              }
            }]
          }

          function e(a) {
            var c = [],
              d = l(c, b.noop);
            return d.chars(a), c.join("")
          }

          function f(a) {
            var b, c = {},
              d = a.split(",");
            for (b = 0; b < d.length; b++) c[d[b]] = !0;
            return c
          }

          function g(a, c) {
            function d(a, d, f, g) {
              if (d = b.lowercase(d), D[d])
                for (; k.last() && E[k.last()];) e("", k.last());
              C[d] && k.last() == d && e("", d), g = z[d] || !!g, g || k.push(d);
              var i = {};
              f.replace(p, function(a, b, c, d, e) {
                var f = c || d || e || "";
                i[b] = h(f)
              }), c.start && c.start(d, i, g)
            }

            function e(a, d) {
              var e, f = 0;
              if (d = b.lowercase(d))
                for (f = k.length - 1; f >= 0 && k[f] != d; f--);
              if (f >= 0) {
                for (e = k.length - 1; e >= f; e--) c.end && c.end(k[e]);
                k.length = f
              }
            }
            "string" != typeof a && (a = null === a || "undefined" == typeof a ? "" : "" + a);
            var f, g, i, j, k = [],
              l = a;
            for (k.last = function() {
                return k[k.length - 1]
              }; a;) {
              if (j = "", g = !0, k.last() && G[k.last()]) a = a.replace(new RegExp("([^]*)<\\s*\\/\\s*" + k.last() + "[^>]*>", "i"), function(a, b) {
                return b = b.replace(s, "$1").replace(v, "$1"), c.chars && c.chars(h(b)), ""
              }), e("", k.last());
              else {
                if (y.test(a)) {
                  if (i = a.match(y)) {
                    i[0];
                    c.whitespace && c.whitespace(i[0]), a = a.replace(i[0], ""), g = !1
                  }
                } else t.test(a) ? (i = a.match(t), i && (c.comment && c.comment(i[1]), a = a.replace(i[0], ""), g = !1)) : u.test(a) ? (i = a.match(u), i && (a = a.replace(i[0], ""), g = !1)) : r.test(a) ? (i = a.match(o), i && (a = a.substring(i[0]
                    .length),
                  i[0].replace(o, e), g = !1)) : q.test(a) && (i = a.match(n), i ? (i[4] && (a = a.substring(i[0].length), i[0].replace(n, d)), g = !1) : (j += "<", a = a.substring(1)));
                g && (f = a.indexOf("<"), j += 0 > f ? a : a.substring(0, f), a = 0 > f ? "" : a.substring(f), c.chars && c.chars(h(j)))
              }
              if (a == l) throw m("badparse", "The sanitizer was unable to parse the following block of html: {0}", a);
              l = a
            }
            e()
          }

          function h(a) {
            if (!a) return "";
            var b = N.exec(a),
              c = b[1],
              d = b[3],
              e = b[2];
            return e && (M.innerHTML = e.replace(/</g, "&lt;"), e = "textContent" in M ? M.textContent : M.innerText), c + e + d
          }

          function i(a) {
            return a.replace(/&/g, "&amp;").replace(w, function(a) {
              var b = a.charCodeAt(0),
                c = a.charCodeAt(1);
              return "&#" + (1024 * (b - 55296) + (c - 56320) + 65536) + ";"
            }).replace(x, function(a) {
              var b = a.charCodeAt(0);
              return 159 >= b || 173 == b || b >= 1536 && 1540 >= b || 1807 == b || 6068 == b || 6069 == b || b >= 8204 && 8207 >= b || b >= 8232 && 8239 >= b || b >= 8288 && 8303 >= b || 65279 == b || b >= 65520 && 65535 >= b ? "&#" + b + ";" :
                a
            }).replace(/</g, "&lt;").replace(/>/g, "&gt;")
          }

          function j(a) {
            var c = "",
              d = a.split(";");
            return b.forEach(d, function(a) {
              var d = a.split(":");
              if (2 == d.length) {
                var e = O(b.lowercase(d[0])),
                  a = O(b.lowercase(d[1]));
                (("color" === e || "background-color" === e) && (a.match(/^rgb\([0-9%,\. ]*\)$/i) || a.match(/^rgba\([0-9%,\. ]*\)$/i) || a.match(/^hsl\([0-9%,\. ]*\)$/i) || a.match(/^hsla\([0-9%,\. ]*\)$/i) || a.match(/^#[0-9a-f]{3,6}$/i) || a.match(
                  /^[a-z]*$/i)) || "text-align" === e && ("left" === a || "right" === a || "center" === a || "justify" === a) || "float" === e && ("left" === a || "right" === a || "none" === a) || ("width" === e || "height" === e) && a.match(
                  /[0-9\.]*(px|em|rem|%)/) || "direction" === e && a.match(/^ltr|rtl|initial|inherit$/)) && (c += e + ": " + a + ";")
              }
            }), c
          }

          function k(a, b, c, d) {
            return "img" === a && b["ta-insert-video"] && ("ta-insert-video" === c || "allowfullscreen" === c || "frameborder" === c || "contenteditable" === c && "false" === d) ? !0 : !1
          }

          function l(a, c) {
            var d = !1,
              e = b.bind(a, a.push);
            return {
              start: function(a, f, g) {
                a = b.lowercase(a), !d && G[a] && (d = a), d || H[a] !== !0 || (e("<"), e(a), b.forEach(f, function(d, g) {
                  var h = b.lowercase(g),
                    l = "img" === a && "src" === h || "background" === h;
                  ("style" === h && "" !== (d = j(d)) || k(a, f, h, d) || L[h] === !0 && (I[h] !== !0 || c(d, l))) && (e(" "), e(g), e('="'), e(i(d)), e('"'))
                }), e(g ? "/>" : ">"))
              },
              comment: function(a) {
                e(a)
              },
              whitespace: function(a) {
                e(i(a))
              },
              end: function(a) {
                a = b.lowercase(a), d || H[a] !== !0 || (e("</"), e(a), e(">")), a == d && (d = !1)
              },
              chars: function(a) {
                d || e(i(a))
              }
            }
          }
          var m = b.$$minErr("$sanitize"),
            n = /^<((?:[a-zA-Z])[\w:-]*)((?:\s+[\w:-]+(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/?)\s*(>?)/,
            o = /^<\/\s*([\w:-]+)[^>]*>/,
            p = /([\w:-]+)(?:\s*=\s*(?:(?:"((?:[^"])*)")|(?:'((?:[^'])*)')|([^>\s]+)))?/g,
            q = /^</,
            r = /^<\//,
            s = /<!--(.*?)-->/g,
            t = /(^<!--.*?-->)/,
            u = /<!DOCTYPE([^>]*?)>/i,
            v = /<!\[CDATA\[(.*?)]]>/g,
            w = /[\uD800-\uDBFF][\uDC00-\uDFFF]/g,
            x = /([^\#-~| |!])/g,
            y = /^(\s+)/,
            z = f("area,br,col,hr,img,wbr,input"),
            A = f("colgroup,dd,dt,li,p,tbody,td,tfoot,th,thead,tr"),
            B = f("rp,rt"),
            C = b.extend({}, B, A),
            D = b.extend({}, A, f("address,article,aside,blockquote,caption,center,del,dir,div,dl,figure,figcaption,footer,h1,h2,h3,h4,h5,h6,header,hgroup,hr,ins,map,menu,nav,ol,pre,script,section,table,ul")),
            E = b.extend({}, B, f("a,abbr,acronym,b,bdi,bdo,big,br,cite,code,del,dfn,em,font,i,img,ins,kbd,label,map,mark,q,ruby,rp,rt,s,samp,small,span,strike,strong,sub,sup,time,tt,u,var")),
            F = f(
              "animate,animateColor,animateMotion,animateTransform,circle,defs,desc,ellipse,font-face,font-face-name,font-face-src,g,glyph,hkern,image,linearGradient,line,marker,metadata,missing-glyph,mpath,path,polygon,polyline,radialGradient,rect,set,stop,svg,switch,text,title,tspan,use"
            ),
            G = f("script,style"),
            H = b.extend({}, z, D, E, C, F),
            I = f("background,cite,href,longdesc,src,usemap,xlink:href"),
            J = f(
              "abbr,align,alt,axis,bgcolor,border,cellpadding,cellspacing,class,clear,color,cols,colspan,compact,coords,dir,face,headers,height,hreflang,hspace,id,ismap,lang,language,nohref,nowrap,rel,rev,rows,rowspan,rules,scope,scrolling,shape,size,span,start,summary,target,title,type,valign,value,vspace,width"
            ),
            K = f(
              "accent-height,accumulate,additive,alphabetic,arabic-form,ascent,attributeName,attributeType,baseProfile,bbox,begin,by,calcMode,cap-height,class,color,color-rendering,content,cx,cy,d,dx,dy,descent,display,dur,end,fill,fill-rule,font-family,font-size,font-stretch,font-style,font-variant,font-weight,from,fx,fy,g1,g2,glyph-name,gradientUnits,hanging,height,horiz-adv-x,horiz-origin-x,ideographic,k,keyPoints,keySplines,keyTimes,lang,marker-end,marker-mid,marker-start,markerHeight,markerUnits,markerWidth,mathematical,max,min,offset,opacity,orient,origin,overline-position,overline-thickness,panose-1,path,pathLength,points,preserveAspectRatio,r,refX,refY,repeatCount,repeatDur,requiredExtensions,requiredFeatures,restart,rotate,rx,ry,slope,stemh,stemv,stop-color,stop-opacity,strikethrough-position,strikethrough-thickness,stroke,stroke-dasharray,stroke-dashoffset,stroke-linecap,stroke-linejoin,stroke-miterlimit,stroke-opacity,stroke-width,systemLanguage,target,text-anchor,to,transform,type,u1,u2,underline-position,underline-thickness,unicode,unicode-range,units-per-em,values,version,viewBox,visibility,width,widths,x,x-height,x1,x2,xlink:actuate,xlink:arcrole,xlink:role,xlink:show,xlink:title,xlink:type,xml:base,xml:lang,xml:space,xmlns,xmlns:xlink,y,y1,y2,zoomAndPan"
            ),
            L = b.extend({}, I, K, J),
            M = document.createElement("pre"),
            N = /^(\s*)([\s\S]*?)(\s*)$/,
            O = function() {
              return String.prototype.trim ? function(a) {
                return b.isString(a) ? a.trim() : a
              } : function(a) {
                return b.isString(a) ? a.replace(/^\s\s*/, "").replace(/\s\s*$/, "") : a
              }
            }();
          b.module("ngSanitize", []).provider("$sanitize", d), b.module("ngSanitize").filter("linky", ["$sanitize", function(a) {
            var c = /((ftp|https?):\/\/|(www\.)|(mailto:)?[A-Za-z0-9._%+-]+@)\S*[^\s.;,(){}<>"”’]/,
              d = /^mailto:/;
            return function(f, g) {
              function h(a) {
                a && n.push(e(a))
              }

              function i(a, c) {
                n.push("<a "), b.isDefined(g) && n.push('target="', g, '" '), n.push('href="', a.replace(/"/g, "&quot;"), '">'), h(c), n.push("</a>")
              }
              if (!f) return f;
              for (var j, k, l, m = f, n = []; j = m.match(c);) k = j[0], j[2] || j[4] || (k = (j[3] ? "http://" : "mailto:") + k), l = j.index, h(m.substr(0, l)), i(k, j[0].replace(d, "")), m = m.substring(l + j[0].length);
              return h(m), a(n.join(""))
            }
          }])
        }(window, window.angular)
    }({}, function() {
      return this
    }());
  </script>
  <script src="js/textAngularSetup.js"></script>
  <script src='js/textAngular.js'></script>
  <script>
    var JSConfigApp = angular.module('JSConfigApp', ['textAngular']).controller('JSConfigAppCtrl', ['$scope', '$sce', function($scope, $sce) {

      //globals
      var cellOuterWidth;
      var fullSliderContainerWidth;
      $scope.pageNumber = 0;
      $scope.setPageNumber = function(index) {
        $scope.pageNumber = index;
      }

      // this object has all the parameters for our drawer
      $scope.promos = {
        global: {
          launchDate: "",
          headerText: "",
          subHeaderText: "",
          promos: [{
            bannerContent: {
              imgOrHTML: "img",
              img: {
                contentParameters: {
                  link: false,
                  linkUrl: "",
                  imageMap: "",
                  useMap: false
                },
                images: {
                  path: "",
                  dataUri: ""
                }
              },
              HTML: {
                useLocal: false,
                localHTML: '<h1 style="text-align: center;">Headline</h1>\
    <h4 style="text-align: center;">Subheader</h4>\
    <p style="text-align: center;">Some optional info</p>\
    <p style="text-align: center;">\
    <a href="/category.html" target="">Link 1</a>&nbsp;\
    <a href="/cat.html">Link 2</a>\
    </p>',
                backgroundColor: "#FFFFFF",
                path: ""
              }
            },
            tapContent: {
              displayType: "generic",
              legalOverride: "",
              useLegalOverride: false,
              genericCodeId: "",
              genericCode: ""
            }
          }]
        }
      }

      $scope.delete = function(idx) {
        $scope.promos.global.promos.splice(idx, 1);
        fullSliderContainerWidth = cellOuterWidth * $scope.promos.global.promos.length;
        jQuery(".offerspotlight-drawer-slider-items").css('width', fullSliderContainerWidth + "px");
      };

      $scope.moveCell = function(old_index, dir) {
        var new_index = old_index + dir;
        if (new_index >= $scope.promos.global.promos.length) {
          var k = new_index - $scope.promos.global.promos.length;
          while ((k--) + 1) {
            $scope.promos.global.promos.push(undefined);
          }
        }
        $scope.promos.global.promos.splice(new_index, 0, $scope.promos.global.promos.splice(old_index, 1)[0]);
        //return this; // for testing purposes
      };


      $scope.addItem = function() {
        $scope.promos.global.promos.push({
          bannerContent: {
            imgOrHTML: "img",
            img: {
              contentParameters: {
                link: false,
                linkUrl: "",
                imageMap: "",
                useMap: false
              },
              images: {
                path: "",
                dataUri: ""
              }
            },
            HTML: {
              useLocal: false,
              localHTML: '<h1 style="text-align: center;">Headline</h1>\
      <h4 style="text-align: center;">Subheader</h4>\
      <p style="text-align: center;">Some optional info</p>\
      <p style="text-align: center;">\
      <a href="/category.html">Link 1</a>&nbsp;\
      <a href="/cat.html">Link 2</a>\
      </p>',
              backgroundColor: "#FFFFFF",
              path: ""
            }
          },
          tapContent: {
            displayType: "generic",
            legalOverride: "",
            useLegalOverride: false,
            genericCodeId: "",
            genericCode: ""
          }
        });
        cellOuterWidth = jQuery(".offerspotlight-drawer-slider-item").outerWidth(true);
        fullSliderContainerWidth = cellOuterWidth * $scope.promos.global.promos.length;
        jQuery(".offerspotlight-drawer-slider-items").css('width', fullSliderContainerWidth + "px");
      };

      // experimental function for pulling in PPC iframe to ensure accurate code is chosen
      $scope.cleanUrl = function(index) {
        return $sce.trustAsResourceUrl("https://secure.www.brol.wip.gidapps.com/buy/promo_legal_details.do?promoId=" + $scope.promos.global.promos[index].tapContent.genericCodeId);
      }


      // This section deals with importing a json file and then building out our global
      // configuration and updating the view.

      jQuery("#the-file-input").change(function() {
        $scope.renderJSON(this.files[0]);
      });

      $scope.renderJSON = function(file) {
        var fr = new FileReader();
        fr.onload = function(e) {
          var newArr = JSON.parse(e.target.result);
          $scope.$apply($scope.promos = newArr);
          cellOuterWidth = jQuery(".offerspotlight-drawer-slider-item").outerWidth(true);
          fullSliderContainerWidth = cellOuterWidth * $scope.promos.global.promos.length;
          jQuery(".offerspotlight-drawer-slider-items").css('width', fullSliderContainerWidth + "px");
          jQuery('.redeem').on('click', function() {
            jQuery(this).toggleClass('applied');
            jQuery(this).toggleText('Applied At Bag', 'Redeem Now')
            return false;
          });
        }
        fr.readAsText(file);
      }

      // JSON export function
      $scope.myEncodeJson = function(obj) {
        newObj = this.stripClone(obj);
        return JSON.stringify(newObj);
      };

      $scope.stripClone = function(obj) {
        if (null == obj || "object" != typeof obj) return obj;
        var copy = obj.constructor();
        for (var attr in obj) {
          if (obj.hasOwnProperty(attr) && attr != '$$hashKey') {
            var obj_attr = obj[attr];
            if (typeof obj_attr == "object") {
              copy[attr] = this.stripClone(obj_attr);
            } else if (typeof obj_attr == "array") {
              copy[attr] = [];
              for (var i = 0; i < obj_attr.length; i++) {
                copy[attr].push(this.stripClone(obj_attr));
              }
            } else {
              copy[attr] = obj_attr;
            }
          }
        }
        return copy;
      };




      // load up an image and convert it to a dataURI
      jQuery(document).on('change', '#the-img-input', function() {
        $scope.renderURI(this, function(dataUri) {
          $scope.$apply($scope.promos.global.promos[$scope.pageNumber].bannerContent.img.images.dataUri = dataUri);
        });
      });

      $scope.renderURI = function(input, callback) {
        var image = new Image();
        image.onload = function() {
          var canvas = document.createElement('canvas');
          canvas.width = this.naturalWidth; // or 'width' if you want a special/scaled size
          canvas.height = this.naturalHeight; // or 'height' if you want a special/scaled size
          canvas.getContext('2d').drawImage(this, 0, 0);
          $scope.imgError = "";
          if (canvas.width != 331 && canvas.height != 183) {
            $scope.imgError = 'Your image is ' + canvas.width + ' pixels wide by ' + canvas.height + ' pixels high. Recommended dimensions are 331 pixels wide by 183 pixels high. Your image may be distorted.';
          }

          callback(canvas.toDataURL('image/jpeg').replace(/^data:image\/(png|jpg);base64,/, ''));

        };

        if (input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function(e) {
            image.src = e.target.result;
          }
          reader.readAsDataURL(input.files[0]);
        }
      }

      $scope.erasePic = function(index) {
        $scope.promos.global.promos[index].bannerContent.img.images.dataUri = "";
      }




      // handle the changing of the background in editor and preview
      $scope.bgColorChange = function(index) {
        jQuery('.ta-text:eq("' + index + '"), .html-preview:eq("' + index + '")').css('background-color', $scope.promos.global.promos[index].bannerContent.HTML.backgroundColor);
      }

      // attach event to tap to apply button
      $scope.attachRedeem = function() {
        jQuery('.redeem').on('click', function() {
          jQuery(this).toggleClass('applied');
          jQuery(this).toggleText('Applied At Bag', 'TAP TO APPLY')
          return false;
        });
      }
    }]);

    JSConfigApp.config(['$compileProvider', function($compileProvider) {
      $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file|data|blob):/);
    }]);

    jQuery.fn.toggleText = function(t1, t2) {
      if (this.text() == t1) this.text(t2);
      else this.text(t1);
      return this;
    };
  </script>
</body>

</html>
